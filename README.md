# Arknights Script Parser  

A header only C++ library to analysis raw story scripts of Arknights.

***将会在2021年1月23日开始重构***

一个用于解析明日方舟剧情原始脚本的纯头文件C++库。

**视频合成部分暂未完成**

## 简介

本库由 [@染色XYX](https://space.bilibili.com/13610200) 编写。

基础功能需要Boost库支持，扩展功能需要Qt或OpenCV支持。

`core.hpp`是库的核心文件，定义了`TokenType`和`token`。

`lexer.hpp`实现了简单的词法分析。

`manager.hpp`是库的中枢，用于根据词法分析结果和信号-槽机制调用相应函数。

`videocore.hpp`用于进一步解析词法分析结果，生成`上下文`。`上下文`可以用于生成视频 *（未完成）*

## 本库依照的原则

### `token`结构

明日方舟脚本每一条`token`都为以下结构：

`[func(key=value,...)] text`

函数不分大小写。

当中括号内为`name="$a_name"`时，函数为`name`，参数列表为`name="$a_name"`

当没有中括号时，函数为`plaintext`

### 环境、上下文与组件

由于合成视频的需要，无法按照GUI的方法生成每一帧。需要引入`环境`、`上下文`和`组件`的概念。

`上下文`由`token`的`block`属性决定，从`block`开始到`block`结束。按先后顺序存储了`token`，和若干`组件`。

`环境`指示了每一个`上下文`的最终属性，如`character`的位置等。用于下一个`上下文`的初始化。

`组件`由许多`cv::Mat`顺序组成，均为`CV8_UC4`。代表一个`上下文`的某一组成部分，如左侧的角色等。

解析过程中，先由`环境`读入`token`，按照`上下文`的生成规则生成`上下文`。读取完成后，每一个`上下文`进行初始化，生成`组件`，随后`组件`按照顺序执行保存的`token`。处理完成后对齐帧数。

## 命名空间

* `arksp`

## 类和方法

`core.hpp`

* `typedef std::tuple<std::string, std::vector<std::pair<std::string, std::string>>, std::string> token`

`manager.hpp`

* `typedef boost::signals2::signal<void(std::string, std::vector<std::pair<std::string, std::string>>)> arksp::Manager::SignalType`

`videocore.hpp`

* `typedef std::pair<std::string, std::vector<std::pair<std::string, std::string>>> arksp::Context::FuncType`

* `typedef std::vector<std::pair<std::string, std::string>> arksp::Environment::EnvState`

* `typedef std::vector<std::pair<std::string, std::string>> arksp::Environment::PropType`

### `arksp::Lexer`

|函数|作用|
|---|---|
|`static std::vector<arksp::token> lexer(const std::string& text)`|用于词法分析|

### `arksp::Manager`

|函数|作用|
|---|---|
|`bool init(const std::vector<arksp::token>& vecToken)`|用于初始化`Manager`|
|`bool connect(const std::string& func_name, const std::function<void(ARKSP_SIGNAL_TYPE())>& slot, const int& group = 0)`|注册`func_name`信号所对应的槽（无`ARKSP_QT`环境）|
|`bool connect(const std::string& func_name, std::function<void(ARKSP_SIGNAL_TYPE())>&& slot, const int& group = 0)`|注册`func_name`信号所对应的槽（无`ARKSP_QT`环境）|
|`bool connect(const std::function<void(ARKSP_SIGNAL_GLOBAL())>& slot, const int& group = 0`|注册对所有信号响应的槽（无`ARKSP_QT`环境）|
|`bool connect(std::function<void(ARKSP_SIGNAL_GLOBAL())>&& slot, const int& group = 0`|注册对所有信号响应的槽（无`ARKSP_QT`环境）|
|`bool disconnect(const int& group)`|断开id为`group`的信号（无`ARKSP_QT`环境）|
|`bool disconnect(const std::string& func_name, const int& group)`|断开与`func_name`信号连接的、id为`group`的槽（无`ARKSP_QT`环境）|
|`bool ptrForward(const unsigned int& step = 1)`|内建指针向前移动`step`步|
|`bool ptrBackward(const unsigned int& step = 1)`|内建指针向后移动`step`步|
|`bool ptrMoveToPoint(const std::string & choice)`|内建指针移动至`references`为`choice`的`predicate token`|
|`bool ptrGoto(const unsigned int& point)`|内建指针移动至`point`|
|`bool ptrRewind()`|内建指针回到第一个`token`|
|`bool ptrFastForward()`|内建指针移动至最后一个`token`|
|`arksp::token getToken(void)`|获得指针当前所指`token`|
|`std::vector<arksp::token>::size_type getIndex(void)`|获得当前指针索引|
|`getSize()`|获得`token`总数|
|`QString getFuncName()`|获得当前指针所指`token`的函数名（ARKSP_INVO环境）|
|`QString getText()`|获得当前指针所指`token`的文本（ARKSP_INVO环境）|
|`QVariantMap getPropMap()`|获得当前指针所指`token`的`Prop`（ARKSP_INVO环境）|`bool replace(const std::string & json)`|根据`json`替换变量|
|`bool setNickname(const std::string & nickname)`|设定博士名称|
|`arksp::token operator[](const std::vector<arksp::token>::size_type& index)`|获得索引为`index`的`token`|
|`void emitSignal()`|发送信号|

**当环境为`ARKSP_QT`时，信号为`void signalToken(QString func_name, QVariantMap prop_map, QString text)`和`void signalException(QString exception)`**

### `arksp::Environment`

|函数|作用|
|---|---|
|`void slotRead(ARKSP_SIGNAL_GLOBAL(func, text, prop))`|用于读取`token`|
|`EnvState* getContext(std::vector<EnvState>::size_type index)`|用于获取位于`index`的`Context`|

## 标记宏

|宏|作用|
|---|---|
|`ARKSP_QT`|停用Boost信号-槽，启用Qt信号-槽|
|`ARKSP_INVO`|启用Qt Quick支持|
|`ARKSP_CONTEXT`|启用视频合成功能（需OpenCV）**未完成**|

## 许可证

### Boost

```
Boost Software License - Version 1.0 - August 17th, 2003

Permission is hereby granted, free of charge, to any person or organization
obtaining a copy of the software and accompanying documentation covered by
this license (the "Software") to use, reproduce, display, distribute,
execute, and transmit the Software, and to prepare derivative works of the
Software, and to permit third-parties to whom the Software is furnished to
do so, all subject to the following:

The copyright notices in the Software and this entire statement, including
the above license grant, this restriction and the following disclaimer,
must be included in all copies of the Software, in whole or in part, and
all derivative works of the Software, unless such copies or derivative
works are solely in the form of machine-executable object code generated by
a source language processor.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
```

### Qt

[LGPL-3](https://www.gnu.org/licenses/lgpl-3.0.en.html)

### OpenCV

[Apache 2 License](https://github.com/opencv/opencv/blob/master/LICENSE)
